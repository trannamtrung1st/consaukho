@page "/order/{id}"
@model CSK.Admin.Pages.Order.DetailModel
@{
}


@section style{
<style>
    .status-new {
        color: blue;
    }

    .status-accepted {
        color: brown;
    }

    .status-cancled {
        color: red;
    }

    .status-finished {
        color: forestgreen;
    }
</style>
}

<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        Chi tiết hóa đơn: <b id="order-id"><!-- dynamic data --></b>

        <a href="../" class="btn btn-link pull-right">
            Trở lại
        </a>
    </h1>

</section>

<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="box box-success">
                <div class="box-header with-border">
                    <h3 class="box-title">Thông tin đơn hàng</h3>
                </div>
                <!-- /.box-header -->
                <!-- form start -->
                <form role="form">
                    <div class="box-body">
                        <div class="form-group">
                            <label>Thông tin khách hàng:</label>
                            <div style="padding-left:50px;">
                                <div><b>Tên</b>: <span id="customer-name"><!--dynamic--></span></div>
                                <div><b>Điện thoại</b>: <span id="customer-phone"><!--dynamic--></span></div>
                                <div><b>Email</b>: <span id="customer-email"><!--dynamic--></span></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Chi tiết:</label>
                            <div style="padding-left:50px;">
                                <div><b>Tổng ban đầu</b>: <span id="total-amount"><!--dynamic--></span> (VND)</div>
                                <div><b>Tổng cuối cùng</b>: <span id="final-amount"><!--dynamic--></span> (VND)</div>
                                <div><b>Phương thức thanh toán</b>: <span id="payment-type"><!--dynamic--></span></div>
                                <div><b>Địa chỉ giao hàng</b>: <span id="ship-address"><!--dynamic--></span></div>
                                <div><b>Tình trạng</b>: <span id="status"><!--dynamic--></span></div>
                            </div>
                            <br/>
                            <div style="padding: 0 40px;">

                                <table id="tbl-details" class="table table-hover">
                                    <tr>
                                        <th>Số lượng</th>
                                        <th>Sản phẩm</th>
                                        <th>Tổng ban đầu (VND)</th>
                                        <th>Tổng cuối cùng (VND)</th>
                                    </tr>

                                </table>

                            </div>
                        </div>
                        <div class="form-group">
                            <label>Sự kiện:</label>
                            <div style="padding-left:50px;">
                                <div><b>Thời gian đặt</b>: <span id="order-time"><!--dynamic--></span></div>
                                <div style="display:none"><b>Đã duyệt vào</b>: <span id="accepted-time"><!--dynamic--></span></div>
                                <div style="display:none"><b>Đã hoàn thành vào</b>: <span id="finished-time"><!--dynamic--></span></div>
                                <div style="display:none"><b>Đã hủy vào</b>: <span id="cancled-time"><!--dynamic--></span></div>
                            </div>
                        </div>
                    </div>
                    <!-- /.box-body -->

                    <div class="box-footer">
                        <button type="button" style="display:none" class="btn btn-primary" id="btn-accept" onclick="acceptOrder()">Duyệt</button>
                        <button type="button" style="display:none" class="btn btn-success" id="btn-pay" onclick="payOrder()">Hoàn thành</button>
                        <button type="button" style="display:none" class="btn btn-danger" id="btn-cancle" onclick="cancleOrder()">Hủy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</section>
<!-- /.content -->
@section script {
<script>

    pageInit();
    function pageInit() {
        loadOrder();
    }


    function loadOrder() {
        function addDetail(d) {
            var table = $('#tbl-details');
            table.append(
                $('<tr>').append(
                    $('<td>' + d.quantity + '</td>')
                ).append(
                    $('<td><a href="/product/' + d.product_id + '/" target="blank">' + d.product_name + '</a></td>')
                ).append(
                    $('<td>' + d.total_amount + '</td>')
                ).append(
                    $('<td>' + d.final_amount + '</td>')
                )
            );
        }

        function toPaymentTypeText(type) {
            if (type == 'cod')
                return 'Ship COD';
            if (type == 'transfer')
                return 'Chuyển khoản';
        }

        function setStatus(status) {
            var stt = $('#status');
            if (status == 'New') {
                stt.text('Mới');
                stt.addClass('status-new');
                $('#btn-accept').show();
                $('#btn-cancle').show();
            } else if (status == 'Accepted') {
                stt.text('Đã duyệt');
                stt.addClass('status-accepted');
                $('#btn-pay').show();
                $('#btn-cancle').show();
            } else if (status == 'Cancled') {
                stt.text('Đã hủy');
                stt.addClass('status-cancled');
            } else if (status == 'Finished') {
                stt.text('Đã hoàn thành');
                stt.addClass('status-finished');
            }
        }

        $.ajax({
            url: '/api/sale-orders/@Model.Id',
            type: 'get',
            success: (data) => {
                console.log(data);

                $('#order-id').text(data.id);
                $('#customer-name').text(data.customer.name);
                $('#customer-phone').text(data.customer.phone);
                $('#customer-email').text(data.customer.email);
                $('#total-amount').text(toMoneyFormat(data.total_amount.toString()));
                $('#final-amount').text(toMoneyFormat(data.final_amount.toString()));
                $('#payment-type').text(toPaymentTypeText(data.payment_type));
                $('#ship-address').text(data.ship_address);
                setStatus(data.status);

                $('#order-time').text(data.order_time);
                if (data.accepted_time) {
                    $('#accepted-time').text(data.accepted_time);
                    $('#accepted-time').parent().show();
                }
                if (data.cancled_time) {
                    $('#cancled-time').text(data.cancled_time);
                    $('#cancled-time').parent().show();
                }
                if (data.finished_time) {
                    $('#finished-time').text(data.finished_time);
                    $('#finished-time').parent().show();
                }

                for (var i = 0; i < data.details.length; i++) {
                    var d = data.details[i];
                    addDetail(d);
                }

            },
            error: (data) => {
                console.log(data);
                data = data.responseJSON;
                Swal.fire({
                    type: 'error',
                    title: 'Message',
                    text: data.message,
                });
            }
        });
    }

    function acceptOrder() {
        Swal.fire({
            title: 'Bạn chắc chắn muốn duyệt đơn này?',
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Chắc chắn',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.value) {
                $.ajax({
                    url: '/api/sale-orders/@Model.Id/status?value=Accepted',
                    type: 'patch',
                    success: (data) => {
                        console.log(data);
                        location.reload();
                    },
                    error: (data) => {
                        console.log(data);
                        data = data.responseJSON;
                        Swal.fire({
                            type: 'error',
                            title: 'Message',
                            text: data.message,
                        });
                    }
                });
            }
        });
    }

    function payOrder() {
        Swal.fire({
            title: 'Bạn chắc chắn muốn hoàn thành đơn này?',
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Chắc chắn',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.value) {
                $.ajax({
                    url: '/api/sale-orders/@Model.Id/status?value=Finished',
                    type: 'patch',
                    success: (data) => {
                        console.log(data);
                        location.reload();
                    },
                    error: (data) => {
                        console.log(data);
                        data = data.responseJSON;
                        Swal.fire({
                            type: 'error',
                            title: 'Message',
                            text: data.message,
                        });
                    }
                });
            }
        });
    }

    function cancleOrder() {
        Swal.fire({
            title: 'Bạn chắc chắn muốn hủy đơn này?',
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Chắc chắn',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.value) {
                $.ajax({
                    url: '/api/sale-orders/@Model.Id/status?value=Cancled',
                    type: 'patch',
                    success: (data) => {
                        console.log(data);
                        location.reload();
                    },
                    error: (data) => {
                        console.log(data);
                        data = data.responseJSON;
                        Swal.fire({
                            type: 'error',
                            title: 'Message',
                            text: data.message,
                        });
                    }
                });
            }
        });
    }

</script>

}
